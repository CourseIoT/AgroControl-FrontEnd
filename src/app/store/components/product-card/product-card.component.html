<mat-card class="!m-0 !rounded-lg !shadow-sm !border !border-gray-200 !overflow-hidden hover:!shadow-lg !transition-shadow !duration-300 h-full flex flex-col">
  <div class="relative h-48 bg-gray-100">
    <img
      mat-card-image
      [src]="product.photoUrl !== ''  && product.photoUrl !== 'string' ? product.photoUrl : 'https://th.bing.com/th/id/OIP.HBh4qLAGWTtaaoTj-F3ySgHaHa?rs=1&pid=ImgDetMain'"
      [alt]="product.name"
      class="!w-full !h-full !object-cover !m-0"
    />
    <div class="absolute top-3 right-3 bg-green-500 text-white px-3 py-1 rounded-full text-xs font-semibold">
      {{ product.quantity }} disponibles
    </div>
  </div>

  <mat-card-content class="!p-4 !bg-white flex-grow flex flex-col">
    <p class="!text-lg !font-bold !mb-1 !text-gray-800 line-clamp-2">{{ product.name }}</p>
    <p *ngIf="showField === 1" class="!text-gray-600 !text-xs !mb-2">{{ 'products.quantityPerUnit' | translate }}: {{ product.quantityPerUnit }}</p>
    <p *ngIf="showField === 2" class="!text-gray-600 !text-xs !mb-2">Cantidad por unidad: {{ product.quantityPerUnit }}</p>

    <div class="mt-auto">
      <p class="!text-2xl !font-bold !text-green-600 !m-0 !mb-3">${{ product.unitPrice.toFixed(2) }}</p>
    </div>
  </mat-card-content>

  <mat-card-actions class="!p-4 !bg-gray-50 !flex !justify-center">
    <button
      mat-raised-button
      *ngIf="showField === 1"
      (click)="editProduct()"
      class="w-full !bg-green-500 !text-white !py-2.5 !rounded-lg !font-semibold !text-sm hover:!bg-green-600 !transition-colors !duration-300"
    >
      {{ 'shared.edit' | translate }}
    </button>
    <button
      mat-raised-button
      *ngIf="showField === 2"
      (click)="showPopUp = true"
      class="w-full !bg-green-500 !text-white !py-2.5 !rounded-lg !font-semibold !text-sm hover:!bg-green-600 !transition-colors !duration-300 !flex !items-center !justify-center !gap-1.5"
    >
      <mat-icon class="!text-base !w-4 !h-4 !leading-none">shopping_cart</mat-icon>
      <span>{{ 'products.buy' | translate }}</span>
    </button>

    <button
      *ngIf="showField === 0"
      class="w-full bg-green-500 px-5 py-2.5 text-white text-sm font-semibold uppercase rounded-lg shadow-md hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 ease-in-out"
      [routerLink]="'/store'">
      Go to Store
    </button>
  </mat-card-actions>
</mat-card>

<div
  *ngIf="showPopUp"
  class="!fixed !inset-0 !bg-black !bg-opacity-50 !flex !items-center !justify-center !z-50 !p-4"
>
  <div
    class="!bg-white !rounded-lg !shadow-2xl !max-w-md !w-full"
    (click)="$event.stopPropagation()"
  >
    <div class="!p-6 !border-b !border-gray-200">
      <div class="!flex !items-center !justify-between">
        <h2 class="!text-2xl !font-bold !text-gray-800 !m-0">Confirmar Compra</h2>
        <button
          (click)="closePopup()"
          class="!text-gray-400 hover:!text-gray-600 !transition-colors !bg-transparent !border-0 !cursor-pointer"
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <form #productForm="ngForm" class="!p-6">
      <div class="!mb-6">
        <img
          [src]="product.photoUrl !== ''  && product.photoUrl !== 'string' ? product.photoUrl : 'https://th.bing.com/th/id/OIP.HBh4qLAGWTtaaoTj-F3ySgHaHa?rs=1&pid=ImgDetMain'"
          [alt]="product.name"
          class="!w-full !h-48 !object-cover !rounded-lg !mb-4"
        />
        <h3 class="!text-xl !font-bold !text-gray-800 !mb-2">{{ product.name }}</h3>
        <p class="!text-gray-600 !m-0">Precio unitario: ${{ product.unitPrice.toFixed(2) }}</p>
        <input
          matInput
          name="productId"
          [(ngModel)]="product.id"
          hidden
        />
      </div>

      <div class="!mb-6">
        <label class="block text-gray-700 font-semibold mb-2">{{ 'products.productQuantity' | translate }}</label>
        <input
          type="number"
          min="1"
          [max]="product.quantity"
          placeholder="Cantidad"
          name="quantityProduct"
          [(ngModel)]="item.quantityProduct"
          required
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
        />
      </div>

      <div class="!bg-gray-50 !rounded-lg !p-4 !mb-6">
        <div class="!flex !justify-between !items-center !text-lg">
          <span class="!font-semibold !text-gray-700">Total:</span>
          <span class="!text-2xl !font-bold !text-green-600">
            ${{ (product.unitPrice * (item.quantityProduct || 0)).toFixed(2) }}
          </span>
        </div>
      </div>

      <div class="!flex !gap-3">
        <button
          type="button"
          mat-raised-button
          (click)="closePopup()"
          [disabled]="purchasing"
          class="!flex-1 !bg-gray-200 !text-gray-800 !py-3 !rounded-lg !font-semibold hover:!bg-gray-300 !transition-colors !duration-300 disabled:!opacity-50"
        >
          Cancelar
        </button>
        <button
          type="button"
          mat-raised-button
          (click)="buyProduct()"
          [disabled]="productForm.invalid || purchasing"
          class="!flex-1 !bg-green-500 !text-white !py-3 !rounded-lg !font-semibold hover:!bg-green-600 !transition-colors !duration-300 disabled:!opacity-50 disabled:!cursor-not-allowed"
        >
          {{ purchasing ? 'Procesando...' : ('products.buy' | translate) }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de éxito -->
<div
  *ngIf="showSuccessMessage"
  class="!fixed !inset-0 !bg-black !bg-opacity-50 !flex !items-center !justify-center !z-[60] !p-4"
  (click)="closeSuccessMessage()"
>
  <div
    class="!bg-white !rounded-lg !shadow-2xl !max-w-sm !w-full !p-8 !text-center"
    (click)="$event.stopPropagation()"
  >
    <div class="!mb-4 !flex !justify-center">
      <div class="!bg-green-100 !rounded-full !p-4">
        <mat-icon class="!text-green-600 !w-12 !h-12 !text-5xl">check_circle</mat-icon>
      </div>
    </div>
    <h3 class="!text-2xl !font-bold !text-gray-800 !mb-2">¡Compra Exitosa!</h3>
    <p class="!text-gray-600 !mb-6">Tu compra se ha realizado correctamente</p>
    <button
      (click)="closeSuccessMessage()"
      class="!w-full !bg-green-500 !text-white !py-3 !rounded-lg !font-semibold hover:!bg-green-600 !transition-colors !duration-300"
    >
      Aceptar
    </button>
  </div>
</div>

<!-- Modal de error -->
<div
  *ngIf="showErrorMessage"
  class="!fixed !inset-0 !bg-black !bg-opacity-50 !flex !items-center !justify-center !z-[60] !p-4"
  (click)="closeErrorMessage()"
>
  <div
    class="!bg-white !rounded-lg !shadow-2xl !max-w-sm !w-full !p-8 !text-center"
    (click)="$event.stopPropagation()"
  >
    <div class="!mb-4 !flex !justify-center">
      <div class="!bg-red-100 !rounded-full !p-4">
        <mat-icon class="!text-red-600 !w-12 !h-12 !text-5xl">error</mat-icon>
      </div>
    </div>
    <h3 class="!text-2xl !font-bold !text-gray-800 !mb-2">Error en la Compra</h3>
    <p class="!text-gray-600 !mb-6">{{ errorMessage }}</p>
    <button
      (click)="closeErrorMessage()"
      class="!w-full !bg-red-500 !text-white !py-3 !rounded-lg !font-semibold hover:!bg-red-600 !transition-colors !duration-300"
    >
      Cerrar
    </button>
  </div>
</div>
